# Perf/Token Report: rtk ssh
Дата: 2026-02-16 23:02:59

## Что измерялось
Источник: `ssh_cmd::tests::visual_review_all_filters` (`src/ssh_cmd.rs:1055`), плюс прогон `cargo test --all-targets`.

## Наблюдаемые метрики сжатия
| Сценарий | Raw chars | Filtered chars | Экономия |
|---|---:|---:|---:|
| psql SELECT (широкая таблица) | 3232 | 670 | 79% |
| psql `\d` schema | 2199 | 713 | 68% |
| JSON logs | 1105 | 100 | 91% |
| HTML page | 1310 | 167 | 87% |
| Generic (`docker ps`) | 1651 | 1098 | 33% |
| psql SELECT (узкие колонки) | 185 | 137 | 26% |

## Вывод по производительности/качеству
- Профиль фильтров хорошо работает для структурированных форматов (JSON/HTML/psql schema).
- Узкое место по token-efficiency: generic path (`src/ssh_cmd.rs:714`) дает низкое сжатие на табличных CLI-выводах.
- Критичный tradeoff: агрессивный hide-column в psql table повышает экономию, но может удалять важный контекст.

## Где можно снизить шум и поднять качество (без роста токенов)
1. `Generic -> table-lite` детектор:
   - Если строки похожи на моноширинную таблицу (`header + separator + rows`), применять table-aware компрессию вместо простого truncate.
   - Ожидаемый эффект: для `docker ps` и подобных выводов сжатие 33% -> ~55-70% при лучшей читаемости.
2. `JSON logs` добавить `other` в summary:
   - Сейчас `other_count` не показывается в строке summary, что скрывает часть сигнала.
   - Формат: `N log lines: X err, Y warn, Z info, W other`.
3. `psql table` режим `safe` для пустой выборки:
   - При `0 rows` не скрывать header.
   - Это уменьшает риск ложных интерпретаций LLM без заметного роста токенов.
4. `verbose contract`:
   - Либо true full-output на `-v`, либо убрать вводящую в заблуждение подсказку.
   - Снижает операционный шум и повторные запросы от модели/оператора.

## Риски производительности при росте нагрузки
- CPU: regex и line-based parsing легкие; узкого места нет.
- Память: `Command::output()` буферизует весь вывод; при очень больших SSH-ответах возможны пики памяти.
- Latency: фильтрация добавляет небольшую post-processing задержку, но с ростом payload может стать заметной.

## Приоритет на следующий шаг
1. Исправить `-v` и поведение на `0 rows`.
2. Добавить generic-table heuristic и тесты на `docker ps`/`kubectl get`.
3. Ввести режимы агрессивности (`strict/balanced/aggressive`) для контролируемого компромисса между токенами и полнотой сигнала.
